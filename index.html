<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<title>لیست محصولات مشتریان</title>
<link rel="stylesheet" href="https://cdn.fontcdn.ir/Font/Vazir/Vazir.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">

<style>
body { font-family: 'Vazir', sans-serif; direction: rtl; padding: 10px; background: #f9f9f9; }
h2 { margin-bottom: 20px; display: flex; align-items: center; gap: 8px; }
.filters { margin-bottom: 20px; display: flex; flex-direction: column; gap: 10px; }
.filter-row { display: flex; align-items: center; gap: 10px; }
.filter-option { display: inline-block; padding: 5px 15px; border: 1px solid #ccc; border-radius: 8px; margin: 3px; cursor: pointer; transition: 0.2s; background: white; }
.filter-option.active { background: #007bff; color: white; border-color: #007bff; }

table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; font-size: 16px; }
th, td { border: 1px solid #ccc; padding: 8px 10px; text-align: center; white-space: nowrap; }
th { background: #f0f0f0; }

button { padding: 8px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; transition: 0.2s; }
.button-group { display: flex; gap: 10px; margin-bottom: 15px; justify-content: flex-start; }

#reset-btn { background: #dc3545; color: white; }
#export-pdf-btn { background: #28a745; color: white; }
#export-png-btn { background: #007bff; color: white; }

#export-pdf-btn:hover { background: #218838; }
#export-png-btn:hover { background: #0056b3; }
#reset-btn:hover { background: #c82333; }

.small-text { font-size: 12px; color: #555; }

.floating-button { position: fixed; top: 10px; left: 10px; background-color: #007BFF; color: white; border: none; border-radius: 50%; width: 50px; height: 50px; display: flex; justify-content: center; align-items: center; font-size: 24px; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
.floating-button:hover { background-color: #0056b3; }

#final-list-container { background: #fff; border: 2px solid #007bff; border-radius: 16px; padding: 20px; margin-top: 40px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
#final-list-container h3 { margin-top: 0; text-align: center; color: #007bff; }

.price-footer { text-align: center; font-weight: 300; font-size: 10px; color: #555; border-top: 1px solid #ccc; padding-top: 10px; line-height: 1.6; }
#current-date { text-align: center; font-weight: 300; font-size: 10px; margin-top: 15px; color: #333; }

@media (max-width: 600px) {
  table { font-size: 13px; }
  th, td { padding: 6px; }
}
</style>
</head>
<body>

<h2>📥 لیست محصولات مشتریان</h2>

<div class="button-group">
  <button id="reset-btn">Reset Filters</button>
  <button id="export-pdf-btn">دانلود PDF</button>
  <button id="export-png-btn">دانلود PNG</button>
</div>

<div class="filters" id="filter-category"></div>

<table id="product-table">
  <thead>
    <tr>
      <th>افزودن</th>
      <th>نام محصول<br><span class="small-text">*** قیمت‌ها به تومان ***</span></th>
      <th>طرح عمومی</th>
      <th>چاپ اختصاصی (رنگی)</th>
      <th>چاپ اختصاصی (تک رنگ)</th>
      <th>قیمت درب</th>
    </tr>
  </thead>
  <tbody id="product-list"></tbody>
</table>

<div id="final-list-container">
  <h3>لیست قیمت محصولات ساکالا</h3>
  <table id="final-table">
    <thead>
      <tr>
        <th>حذف</th>
        <th>نام محصول<br><span class="small-text">*** قیمت‌ها به تومان ***</span></th>
        <th>طرح عمومی</th>
        <th>چاپ اختصاصی<br><span class="small-text">رنگی</span></th>
        <th>چاپ اختصاصی<br><span class="small-text">مونوکالر</span></th>
        <th>قیمت درب</th>
      </tr>
    </thead>
    <tbody id="final-list"></tbody>
  </table>
  
  <div id="current-date"></div>
  <div class="price-footer">
    <p>اعتبار این لیست قیمت ۲۴ ساعت پس از انتشار می‌باشد</p>
  </div>
</div>

<a href="https://sakalaco.github.io/Home/" class="floating-button"><i class="fas fa-home"></i></a>

<script>
// داده‌ها
const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTvY_Dh9wfH7UGfgFOzGhAKwl8nD4lFK9cCHFzTKiu7JfjuZ6QbGAuD_Z_6V9_B_VLvZo21V2kRU4VN/pub?output=csv";
let allData = [];
let activeFilters = { subcategory: [] };
let finalList = [];

function formatNumber(num) {
  if (!num || isNaN(Number(num)) || Number(num) === 0) return "";
  return Number(num).toLocaleString('fa-IR');
}

// دریافت داده‌ها
fetch(sheetUrl)
.then(res => res.text())
.then(text => {
  const rows = text.split("\n").map(r => r.split(","));
  const headers = rows[0];
  const data = rows.slice(1).map(r => {
    let obj = {};
    headers.forEach((h,i) => obj[h.trim()] = r[i]);
    return obj;
  });
  allData = data;
  createFilters(allData);
  renderTable();
});

// فیلترها
function createFilters(data) {
  const container = document.getElementById("filter-category");
  container.innerHTML = "";
  let categories = [...new Set(data.map(d => d.category).filter(Boolean))];

  categories.forEach(cat => {
    const row = document.createElement("div");
    row.className = "filter-row";

    const btn = document.createElement("div");
    btn.className = "filter-option";
    btn.innerText = cat;

    const subContainer = document.createElement("div");
    subContainer.className = "sub-filters";
    const subValues = [...new Set(data.filter(d => d.category === cat).map(d => d.PPL).filter(Boolean))];

    const subButtons = [];
    subValues.forEach(sub => {
      const subBtn = document.createElement("div");
      subBtn.className = "filter-option";
      subBtn.innerText = sub;

      subBtn.onclick = (e) => {
        e.stopPropagation();
        document.querySelectorAll(".filter-option").forEach(f => f.classList.remove("active"));
        subBtn.classList.add("active");
        activeFilters.subcategory = [sub];
        renderTable();
      };

      subContainer.appendChild(subBtn);
      subButtons.push(subBtn);
    });

    btn.onclick = () => {
      document.querySelectorAll(".filter-option").forEach(f => f.classList.remove("active"));
      subButtons.forEach(sb => sb.classList.add("active"));
      activeFilters.subcategory = subButtons.map(sb => sb.innerText);
      renderTable();
    };

    row.appendChild(btn);
    row.appendChild(subContainer);
    container.appendChild(row);
  });
}

// جدول اصلی
function renderTable() {
  const tbody = document.getElementById("product-list");
  tbody.innerHTML = "";

  const filtered = allData.filter(item => {
    return activeFilters.subcategory.length === 0 || activeFilters.subcategory.includes(item.PPL);
  });

  filtered.forEach(item => {
    const tr = document.createElement("tr");

    const exists = finalList.find(f => f.name === item.name);
    const addBtn = document.createElement("button");
    addBtn.innerHTML = exists ? "❌" : "➕";
    addBtn.style.background = exists ? "#dc3545" : "#007bff";
    addBtn.style.color = "white";
    addBtn.onclick = () => toggleFinalItem(item);

    tr.innerHTML = `
      <td></td>
      <td>${item.name || ""}</td>
      <td>${formatNumber(item.price_omomi)}</td>
      <td>${formatNumber(item.price_digital)}</td>
      <td>${formatNumber(item.price_1000)}</td>
      <td>${formatNumber(item.door)}</td>
    `;
    tr.children[0].appendChild(addBtn);
    tbody.appendChild(tr);
  });
}

// جدول نهایی
function toggleFinalItem(item) {
  const index = finalList.findIndex(f => f.name === item.name);
  if (index >= 0) finalList.splice(index, 1);
  else finalList.push(item);
  renderTable();
  renderFinalList();
}

function renderFinalList() {
  const tbody = document.getElementById("final-list");
  tbody.innerHTML = "";
  finalList.forEach((item, idx) => {
    const tr = document.createElement("tr");
    const delBtn = document.createElement("button");
    delBtn.innerText = "❌";
    delBtn.style.background = "#dc3545";
    delBtn.style.color = "white";
    delBtn.onclick = () => { finalList.splice(idx,1); renderFinalList(); renderTable(); };

    tr.innerHTML = `
      <td></td>
      <td>${item.name || ""}</td>
      <td>${formatNumber(item.price_omomi)}</td>
      <td>${formatNumber(item.price_digital)}</td>
      <td>${formatNumber(item.price_1000)}</td>
      <td>${formatNumber(item.door)}</td>
    `;
    tr.children[0].appendChild(delBtn);
    tbody.appendChild(tr);
  });
}

// تاریخ و ساعت
function getPersianDateTime() {
  return new Intl.DateTimeFormat('fa-IR',{
    year:'numeric', month:'2-digit', day:'2-digit',
    hour:'2-digit', minute:'2-digit', second:'2-digit'
  }).format(new Date());
}
setInterval(()=>document.getElementById('current-date').innerText=getPersianDateTime(),1000);

// ریست فیلترها
document.getElementById("reset-btn").onclick = () => {
  activeFilters = { subcategory: [] };
  createFilters(allData);
  renderTable();
};

// دانلود PNG جمع و جور با باکس متناسب
document.getElementById("export-png-btn").onclick = () => {
  const container = document.getElementById("final-list-container");
  const table = document.getElementById("final-table");
  const firstColCells = table.querySelectorAll('th:first-child, td:first-child');

  // مخفی کردن ستون حذف
  firstColCells.forEach(c => c.style.display = 'none');

  // تنظیم جدول جمع و جور
  table.style.width = 'auto';
  table.querySelectorAll('th, td').forEach(cell => {
    cell.style.whiteSpace = 'nowrap';
    cell.style.padding = '4px 8px';
    cell.style.fontSize = '12px';
  });

  // تنظیم باکس متناسب با جدول
  container.style.display = 'inline-block';
  container.style.width = 'auto';

  html2canvas(container).then(canvas => {
    const link = document.createElement("a");
    link.download = `final-table-${new Date().getTime()}.png`;
    link.href = canvas.toDataURL("image/png");
    link.click();

    // بازگردانی استایل‌ها
    firstColCells.forEach(c => c.style.display = '');
    table.style.width = '';
    table.querySelectorAll('th, td').forEach(cell => {
      cell.style.whiteSpace = '';
      cell.style.padding = '';
      cell.style.fontSize = '';
    });
    container.style.display = '';
    container.style.width = '';
  });
};

// دانلود PDF جمع و جور با باکس متناسب
document.getElementById("export-pdf-btn").onclick = () => {
  const container = document.getElementById("final-list-container");
  const table = document.getElementById("final-table");
  const firstColCells = table.querySelectorAll('th:first-child, td:first-child');

  firstColCells.forEach(c => c.style.display = 'none');

  table.style.width = 'auto';
  table.querySelectorAll('th, td').forEach(cell => {
    cell.style.whiteSpace = 'nowrap';
    cell.style.padding = '4px 8px';
    cell.style.fontSize = '12px';
  });

  container.style.display = 'inline-block';
  container.style.width = 'auto';

  html2canvas(container).then(canvas => {
    const imgData = canvas.toDataURL('image/png');
    const pdf = new window.jspdf.jsPDF('p', 'pt', 'a4');
    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
    pdf.save(`final-table-${new Date().getTime()}.pdf`);

    firstColCells.forEach(c => c.style.display = '');
    table.style.width = '';
    table.querySelectorAll('th, td').forEach(cell => {
      cell.style.whiteSpace = '';
      cell.style.padding = '';
      cell.style.fontSize = '';
    });
    container.style.display = '';
    container.style.width = '';
  });
};



</script>
</body>
</html>
